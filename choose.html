<html><head>
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>签约客户经理</title>
    <script src="/WebResources/ClientGlobalContext.js.aspx"></script>
    <script src="/WebResources/hd_jquery.js"></script>
    <link href="/WebResources/gf_bootstrap.min.css" rel="stylesheet">
    <script src="/WebResources/new_rest"></script>
    <script src="/WebResources/gf_XrmServiceToolkit.js"></script>
    <script src="/WebResources/gf_global.js"></script>
<meta><meta><meta></head>

<body style="overflow-wrap: break-word; word-wrap: break-word;">
    <div class="container">
        <div class="row">
            <h1 class="col-md-3">签约客户经理</h1>
            <div class="col-md-3" style="height:24px; margin-top: 35px;">
                <a>
                    <input id="accountid" style="text-align: center;" type="hidden">
                </a>
                <a>
                    <input id="subscribeid" style="text-align: right;" type="hidden">
                </a>
            </div>
        </div>
        <div class="row">
            <table id="table" class="table table-hover table-bordered">
                <!--表头-->
                <thead style="display: table-header-group;">
                    <tr>
                        <th style="text-align:center">
                            <div class="th-inner sortable both asc">是否主副</div>
                        </th>
                        <th style="text-align:center">
                            <div class="th-inner sortable both asc">签约客户经理</div>
                        </th>
                        <th style="text-align:center">
                            <div class="th-inner sortable both">部门</div>
                        </th>
                        <th style="text-align:center">
                            <div class="th-inner sortable both">岗位</div>
                        </th>
                        <th style="text-align:center">
                            <div class="th-inner sortable both">业绩分配比例</div>
                        </th>
                        <th style="text-align:center">
                            <div class="th-inner sortable both">删除</div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="selected">
                        <td style="text-align:center;">主客户经理</td>
                        <td style="text-align: center;" id="mainOwner">
                            <br>
                        </td>
                        <td style="text-align: center; " id="deptName">
                            <br>
                        </td>
                        <td style="text-align:center;" id="position">
                            <span></span>
                            <input value="否" type="hidden">
                        </td>
                        <td style="text-align: center; " id="mainportaion">10</td>
                        <td style="text-align: center; ">
                            <br>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="row">
            <div id="resetdiv" style="display:inline">
                <button id="reset" class="btn btn-info">
                    <i class="glyphicon glyphicon-ok"></i> 重置
                </button>
            </div>
            <div id="savediv" style="display:inline">
                <button id="save" class="btn btn-success">
                    <i class="glyphicon glyphicon-ok"></i> 保存
                </button>
            </div>
            <div id="canceldiv" style="display:inline">
                <button id="unsave" class="btn btn-danger">
                    <i class="glyphicon glyphicon-remove"></i> 取消
                </button>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        //删除当前行
        function deleteRow(obj) {
            debugger;
            $(obj).parent().parent().parent().remove();
        }
        $(document).ready(function () {
            LoadUser();
            //重置按钮
            $("#reset").click(function () {
                debugger;
                window.location.reload();
                //LoadUser();
            });
            //保存按钮
            $("#save").click(function () {
                var accountid = $("#accountid").val();
                var subscribeid = $("#subscribeid").val();
                var contentArr = new Array($("table tr.selected").length);
                var index = 0;
                var portion = 0;
                var tableInfo = 0.00;
                var sistotal = 0;
                var hasFloat = false;
                var name = new Array();
                var checkDuplicate = new Array();
                var r = new fwREST();
                var elecState = r.get("gf_electroniccontractSet?$select=gf_approvalstatus&$filter=gf_subscribid/Id eq guid'" + subscribeid + "'");
                if (elecState != null && elecState != undefined && elecState.length > 0) {
                    var state = elecState[0].gf_approvalstatus.Value;
                    if (!(state == 1010 || state == 1030)) {
                        alert("该电子合同未在编辑状态下，不能选择签约客户经理！");
                        return;
                    }
                }
                $("table tr.selected").each(function () {
                    debugger;
                    contentArr[index] = new Array(6);
                    var tdarr = $(this).children("td");
                    contentArr[index][0] = $(tdarr).eq(0).text();
                    contentArr[index][1] = $(tdarr).eq(1).text();
                    contentArr[index][2] = $(tdarr).eq(2).text();
                    checkDuplicate.push(contentArr[index][1]);//判断签约客户经理选择是否为同一人重复用
                    contentArr[index][3] = {
                        position: $(tdarr).eq(3).find("span").text(),
                        assist: $(tdarr).eq(3).find("input").val()
                    }
                    var assist = $(tdarr).eq(3).find("input").val();
                    if (assist == "是") {
                        sistotal = sistotal + 1;
                    }
                    if ($(tdarr).eq(4).find("input") == undefined) {
                        contentArr[index][4] = $(tdarr).eq(4).val();
                    } else {
                        contentArr[index][4] = $(tdarr).eq(4).children("input").val();
                        
                    }
                    if (contentArr[index][4] != undefined) {
                        //判断是否为整数
                        if (!/^\d+$/.test(contentArr[index][4]))
                        {
                            hasFloat = true;                   
                        }
                        portion = parseInt(contentArr[index][4]) + portion;
                        if (parseInt(contentArr[index][4]) == 0) {
                            name.push(contentArr[index][1]);
                        }
                    }
                    index++;
                    tableInfo += $(this).val();
                });
                //分配比例不能为小数
                if (hasFloat)
                {
                    alert("业绩分配比例不能为小数");
                    return;
                }
                //判断签约客户经理选择是否为同一人重复用
                if (arrRepeat(checkDuplicate))
                {
                    alert("签约客户经理存在同一人，请重新选择！");
                    return;
                }
                //业绩分配比例不能为0
                if (name.length>0) {
                    for(var i=0;i<name.length;i++)
                    {
                        var userdata=_Get("GET",Xrm.Page.context.getClientUrl() + "/api/data/v8.0/systemusers?$select=fullname,jc_sportion&$filter=fullname eq '"+name[i]+"' ",null,false);
                        if (userdata != null && userdata != undefined && userdata.value.length > 0)
                        {
                            var sportion=userdata.value[0].jc_sportion;
                        }
                        if(!sportion)
                        {
                            alert("业绩分配比例不能为0！");
                            return;
                        }
                    }

                }
                //只能有一个助理
                if (sistotal > 1) {
                    alert("协助出单的助理理财师最多只能一个！请重新选择签约客户经理！");
                    return;
                }
                if (index > 3) {
                    alert("共同维护出单人含申请人最多不超过3人！请重新选择签约客户经理！");
                    return;
                }
                //分配比例不为10不能保存，否则记录数据
                if (portion != 10) {
                    alert("除助理协助出单业绩比例外其他业绩分配比例相加必须为10，请重新填写分配比例！");
                    return;
                }
                //记录副客户经理数据到
                CreateOrUpdateContractMana(accountid, subscribeid, contentArr);

            });
            //取消按钮
            $("#unsave").click(function () {
                debugger;
                if (confirm("确定放弃更改？")) {
                    window.close();
                }
            });
        });
        //判断某用户是否具有某一角色
        function UserIdHaveRole(userid, roleName) {
            var rest = new fwREST();
            var roles = rest.get("SystemUserRolesSet?$select=RoleId,SystemUserId&$filter=SystemUserId eq guid'" + userid + "'");
            if (roles != null && roles != undefined && roles.length > 0) {
                for (var i = 0; i < roles.length; i++) {
                    var Role = rest.get("RoleSet?$select=Name&$filter=RoleId eq guid'" + roles[i].RoleId + "'");
                    if (Role != null && Role != undefined && Role.length > 0) {
                        if (Role[0].Name == roleName) return true;
                    }
                }
            }
            return false;
        }
        //判断数组是否重复
        function arrRepeat(arr) {
            var arrStr = JSON.stringify(arr), str;
            for (var i = 0; i < arr.length; i++) {
                if (arrStr.indexOf(arr[i]) != arrStr.lastIndexOf(arr[i])) {
                    return true;
                }
            };
            return false;
        }
        //打开时自动带出客户信息和预约信息
        function LoadUser() {
            debugger;
            var r = new fwREST();
            var userid = Xrm.Page.context.getUserId();
            var name = parent.name;
            var strs = name.split(";");
            var accountid = strs[0].toString();
            var subscribeid = strs[1].toString();
            $("#accountid").val(accountid);
            $("#subscribeid").val(subscribeid);
            var owner = r.get("AccountSet?$select=AccountId,OwnerId&$filter=AccountId eq guid'" + accountid + "'");
            if (owner != null && owner != undefined && owner.length > 0) {
                var ownerid = owner[0].OwnerId.Id;
            }
            //根据客户ID获取理财师手机号，名称，部门
            var systemuser = r.get("SystemUserSet?$select=BusinessUnitId,MobilePhone,FullName,gf_position&$filter=SystemUserId eq guid'"
                + ownerid + "'");
            if (null != systemuser && undefined != systemuser && systemuser.length > 0) {
                var deptname = systemuser[0].BusinessUnitId.Name;
                var cellno = systemuser[0].MobilePhone;
                var username = systemuser[0].FullName;
                var position = systemuser[0].gf_position.Name;
                var trobj = $("#table tr").eq(1).children();
                $(trobj).eq(1).text(username);
                $(trobj).eq(2).text(deptname);
                $(trobj).eq(3).find("span").text(position);
                var isJointly = r.get("gf_ac_jointly_safeguardSet?$select=gf_viceproportion,gf_mainproportion&$filter=gf_accountid/Id eq guid'"
                    + accountid + "'" + " and gf_view_control eq true");
                if (isJointly != null && isJointly != undefined && isJointly.length > 0) {
                    var proportion = isJointly[0].gf_mainproportion;
                    //根据共同维护记录获取主客户经理的分配比例
                    $(trobj).eq(4).html("<input style='width: 30px;text-align: center;' type='text' value='" + proportion + "' />");
                }
            }
            //根据共同维护信息不是视图控制获取副客户经理列表
            var jointly = r.get("gf_ac_jointly_safeguardSet?$select=OwnerId,gf_viceproportion,gf_systemuserid,gf_view_control,gf_mainproportion&$filter=gf_accountid/Id eq guid'"
                + accountid + "'" + " and (gf_view_control eq false or gf_view_control eq null)");
            if (jointly != null && jointly != undefined && jointly.length > 0) {
                for (i = 0; i < jointly.length; i++) {
                    var viceOwner = jointly[i].gf_systemuserid;
                    var viceOwnerid = viceOwner.Id;
                    var viceOwnername = viceOwner.Name;
                    var viceproportion = jointly[i].gf_viceproportion;
                    var mainproportion = jointly[i].gf_mainproportion;
                    if (viceOwnerid != null && viceOwnerid != undefined && !(UserIdHaveRole(viceOwnerid, "GF_客户专员（无证）"))) {
                        var viceSystemUser = r.get("SystemUserSet?$select=BusinessUnitId,MobilePhone,FullName,gf_position&$filter=SystemUserId eq guid'"
                            + viceOwnerid + "'");
                        if (viceSystemUser != null && viceSystemUser != undefined && viceSystemUser.length > 0) {
                            var vicedeptname = viceSystemUser[0].BusinessUnitId.Name;
                            var vicecellno = viceSystemUser[0].MobilePhone;
                            var viceusername = viceSystemUser[0].FullName;
                            var viceposition = viceSystemUser[0].gf_position.Name;
                            var tr = '<tr class="selected">\
                                    <td style="text-align:center;">副客户经理</td>\
                                    <td style="text-align: center; "><a href="#">'+ viceusername + '</a></td>\
                                    <td style="text-align: center; ">'+ vicedeptname + '</td>';
                            //var trobj = $("#table tr").eq(i + 2).children();
                            //$(trobj).eq(1).text(viceusername);
                            //$(trobj).eq(2).text(vicedeptname);
                            //$(trobj).eq(3).find("span").text(viceposition);
                            //$(trobj).eq(4).html("<input style='width:30px;text-align:center;' type='text' value='" + viceproportion + "' />");
                            debugger;
                            if (UserIdHaveRole(viceOwnerid, "GF_客户经理助理")) {
                                tr += '<td style="text-align:center;"><span>' + viceposition + '</span><input type="hidden" value="是"/></td>';
                                tr += '<td style="text-align: center; ">10</td>';
                                //$(trobj).eq(4).text(10);
                                //$(trobj).eq(3).find("input").val("是");
                            }
                            else {
                                tr += '<td style="text-align:center;"><span>' + viceposition + '</span><input type="hidden" value="否"/></td>';
                                tr += '<td style="text-align: center; "><input style="width:30px;text-align:center;"type="text" value=' + viceproportion + ' /></td>';
                                //$(trobj).eq(3).find("input").val("否");
                            }
                            tr += '<td style="text-align: center; "><a class="remove" href="javascript:void(0)" title="Remove"><i class="glyphicon glyphicon-remove" onclick="deleteRow(this)"></i></a></td>\
                                </tr>';
                            $("#table").append(tr);
                        }
                    }
                }
            }
        }
        function CreateOrUpdateContractMana(accountid, subscribeid, contentArr) {
            debugger;
            var r = new fwREST();
            var subscribeid = $("#subscribeid").val();
            var accountid = $("#accountid").val();
            var subscribeName = "";
            var subscribe = r.get("gf_subscribeSet?$select=gf_name&$filter=gf_subscribeId eq guid'" + subscribeid + "'");
            if (subscribe != null && subscribe != undefined && subscribe.length > 0) {
                subscribeName = subscribe[0].gf_name;
            }
            //创建记录前先清理该预约下的记录
            var hasRecord = r.get("gf_contractmanagerSet?$select=gf_contractmanagerId&$filter=jc_subscribeid/Id eq guid'" + subscribeid + "'");
            if (hasRecord != null && hasRecord != undefined && hasRecord.length > 0) {
                for (var i = 0; i < hasRecord.length; i++) {
                    var recordid = hasRecord[i].gf_contractmanagerId;
                    r.del("gf_contractmanager", recordid);
                }
            }

            for (var i = 0; i < contentArr.length; i++) {
                var name = contentArr[i][1];
                var isassist = contentArr[i][3].assist;
                var portion = parseFloat(contentArr[i][4]);
                var ismain = contentArr[i][0];
                //var systemuser=r.get("SystemUserSet?$select=jc_buorg,gf_regionid,gf_businessunitid1,gf_position,gf_businessunitid2,FullName,BusinessUnitId,MobilePhone,SystemUserId&$filter=FullName eq '"+name+"'");
                var systemuser = r.get("SystemUserSet?$select=jc_buorg,gf_regionid,gf_businessunitid1,gf_position,gf_businessunitid2,FullName,BusinessUnitId,MobilePhone,SystemUserId&$filter=FullName eq '" + encodeURIComponent(name) + "'");
                if (systemuser != null && systemuser != undefined && systemuser.length > 0) {
                    var systemuserid = systemuser[0].SystemUserId;//用户ID

                    var businessunit = systemuser[0].BusinessUnitId.Id;//业务部门
                    var businessunitName = systemuser[0].BusinessUnitId.Name;
                    var businessunitLogicalName = systemuser[0].BusinessUnitId.LogicalName;
                    var buorg = systemuser[0].jc_buorg.Id;//财富分部
                    var buorgLogicalName = systemuser[0].jc_buorg.LogicalName;
                    var buorgNamee = systemuser[0].jc_buorg.Name;
                    var regionid = systemuser[0].gf_regionid.Id;//财富各局
                    var regionLogicalName = systemuser[0].gf_regionid.LogicalName;
                    var regionName = systemuser[0].gf_regionid.Name;
                    var branchid = systemuser[0].gf_businessunitid1.Id;//分公司
                    var branchName = systemuser[0].gf_businessunitid1.Name;
                    var branchLogicalName = systemuser[0].gf_businessunitid1.LogicalName;
                    var areaid = systemuser[0].gf_businessunitid2.Id;//区域
                    var areaLogicalName = systemuser[0].gf_businessunitid2.LogicalName;
                    var areaName = systemuser[0].gf_businessunitid2.Name;
                    var gf_position = systemuser[0].gf_position.Id;//岗位
                    var positionName = systemuser[0].gf_position.Name;
                    var positionLogicalName = systemuser[0].gf_position.LogicalName;
                    //开始创建数据
                    var conObject = new Object();
                    conObject.gf_name = "test";
                    conObject.gf_systemuserid = new Object();
                    conObject.gf_systemuserid.LogicalName = "systemuser";
                    conObject.gf_systemuserid.Id = systemuserid;
                    conObject.gf_systemuserid.Name = name;
                    conObject.gf_businessunitid = new Object();
                    conObject.gf_businessunitid.LogicalName = businessunitLogicalName;
                    conObject.gf_businessunitid.Name = businessunitName;
                    conObject.gf_businessunitid.Id = businessunit;
                    conObject.jc_buorg = new Object();
                    conObject.jc_buorg.LogicalName = buorgLogicalName;
                    conObject.jc_buorg.Name = buorgNamee;
                    conObject.jc_buorg.Id = buorg;
                    conObject.gf_regionid = new Object();
                    conObject.gf_regionid.LogicalName = regionLogicalName;
                    conObject.gf_regionid.Name = regionName;
                    conObject.gf_regionid.Id = regionid;
                    conObject.gf_branchid = new Object();
                    conObject.gf_branchid.LogicalName = branchLogicalName;
                    conObject.gf_branchid.Name = branchName;
                    conObject.gf_branchid.Id = branchid;
                    conObject.gf_areaid = new Object();
                    conObject.gf_areaid.LogicalName = areaLogicalName;
                    conObject.gf_areaid.Name = areaName;
                    conObject.gf_areaid.Id = areaid;
                    conObject.jc_position = new Object();
                    conObject.jc_position.LogicalName = positionLogicalName;
                    conObject.jc_position.Name = positionName;
                    conObject.jc_position.Id = gf_position;
                    conObject.jc_subscribeid = new Object();
                    conObject.jc_subscribeid.LogicalName = "gf_subscribe";
                    conObject.jc_subscribeid.Name = subscribeName;
                    conObject.jc_subscribeid.Id = subscribeid;
                    conObject.gf_ismain = new Object();
                    conObject.jc_isassist = new Object();
                    conObject.jc_proportion = new 　Object();
                    conObject.gf_ismain = false;
                    conObject.jc_isassist = false;
                    debugger;
                    if (isassist == "是") {
                        conObject.jc_isassist = true;
                        conObject.jc_proportion = 10;
                    }
                    else {
                        conObject.jc_proportion = portion;
                    }
                    if (ismain == "主客户经理") {
                        conObject.gf_ismain = true;
                    }
                    var data = window.JSON.stringify(conObject);
                    debugger;
                    //根据subscribeid和systemuserid判断唯一性
                    var result = r.create("gf_contractmanager", data);
                }
                else {
                    alert("获取理财师有误！请联系管理员！");
                    return;
                }
            }
            alert("保存成功！");
            window.close();
            localStorage.isSave = (new Date()).getTime();
        }
    </script>








</body></html>